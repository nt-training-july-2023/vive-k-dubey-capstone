package com.backend.employee.serviceimpl;

import com.backend.employee.dto.CommonResponseDto;
import com.backend.employee.dto.ProjectDto;
import com.backend.employee.dto.RegisterDto;
import com.backend.employee.dto.ResponseDto;
import com.backend.employee.entity.ProjectEntity;
import com.backend.employee.entity.RegisterEntity;
import com.backend.employee.exception.DataAlreadyExistsException;
import com.backend.employee.exception.DataNotFoundException;
import com.backend.employee.exception.WrongInputException;
import com.backend.employee.repo.ProjectRepo;
import com.backend.employee.repo.RegisterRepo;
import com.backend.employee.service.AdminService;
import com.backend.employee.validations.InputFieldsChecksUpdated;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class AdminServiceImpl implements AdminService {

    private final RegisterRepo registerRepository;
    private final ProjectRepo projectRepository;
    
    @Autowired
    private InputFieldsChecksUpdated inputFieldChecksUpdated;

    @Autowired
    public AdminServiceImpl(RegisterRepo registerRepository, ProjectRepo projectRepository) {
        this.registerRepository = registerRepository;
        this.projectRepository = projectRepository;
    }

    @Override
    public CommonResponseDto addEmployee(RegisterDto registerDto)throws WrongInputException, DataAlreadyExistsException {
        
      inputFieldChecksUpdated.checkEmpId(registerDto.getEmpId());
      inputFieldChecksUpdated.checkEmpName(registerDto.getEmpName());
      inputFieldChecksUpdated.checkDob(registerDto.getEmpDOB());
      inputFieldChecksUpdated.checkDoj(registerDto.getEmpDOB());
      inputFieldChecksUpdated.checkEmpEmail(registerDto.getEmpEmail());
      //inputFieldChecksUpdated.checkEmpLocation(registerDto.getEmpLocation());
      //inputFieldChecksUpdated.checkEmpDesignation(employeeDto.getEmpDesignation());
      inputFieldChecksUpdated.checkEmpContactNo(registerDto.getEmpContactNo());
      inputFieldChecksUpdated.checkEmpPassword(registerDto.getEmpPassword());
      inputFieldChecksUpdated.checkEmailExistence(registerDto.getEmpEmail());
      inputFieldChecksUpdated.checkEmpIdExistence(registerDto.getEmpId());
      inputFieldChecksUpdated
              .checkEmpContactExistence(registerDto.getEmpContactNo());
//      inputFieldChecksUpdated.checkValidAdminEmail(registerDto.getEmpEmail());
//      String password = "";
//      if (inputFieldChecksUpdated.isPossiblyHashed(employeeDto.getEmpPassword())) {
//          password = employeeDto.getEmpPassword();
//      } else {
//          password = passwordEncoder.encode(employeeDto.getEmpPassword());
//      }
      
      
      
      // Convert DTO to Entity
        RegisterEntity registerEntity = new RegisterEntity(registerDto);
        
        //String skills = String.join(",", registerDto.getEmpSkills());
        registerEntity.setEmpSkills(registerDto.getEmpSkills());
        
        if ("employee".equals(registerDto.getEmpRole())) {
          // Assuming the role of the manager is "admin"
          // You should replace "admin" with the actual role for admins in your application
          // Load the manager's name based on the role
          RegisterEntity managerEntity = registerRepository.findByEmpRole("admin");
          if (managerEntity != null) {
              registerEntity.setManager(managerEntity.getEmpName());
          } else {
              // Handle the case where the admin is not found (perhaps set a default manager)
              registerEntity.setManager("Default Manager");
          }
      } else {
          // For admin or other roles, set manager as null or another default value as needed
          registerEntity.setManager(null);
      }

        registerRepository.save(registerEntity);

        return new CommonResponseDto("Employee added successfully");
    }
    
    
    
    
    @Override
    public List<RegisterDto> getAllEmployees() {
        List<RegisterEntity> managerEntities = registerRepository.findAllByEmpRole("employee");
        System.out.println(managerEntities);

        if ( !managerEntities.isEmpty()) {
            List<RegisterDto> managerDtos = convertToRegisterDtoList(managerEntities);
            return managerDtos;
        } else {
          throw new DataNotFoundException("No employees found");
        }
    }
    
 // Implement a method to convert a list of RegisterEntity objects to RegisterDto objects
    private List<RegisterDto> convertToRegisterDtoList(List<RegisterEntity> entities) {
        List<RegisterDto> dtos = new ArrayList<>();
        for (RegisterEntity entity : entities) {
            RegisterDto dto = new RegisterDto();
            // Map entity fields to dto fields
            dto.setEmpId(entity.getEmpId());
            dto.setEmpName(entity.getEmpName());
            dto.setEmpContactNo(entity.getEmpContactNo());
            dto.setEmpDesignation(entity.getEmpDesignation());
            dto.setEmpDOB(entity.getEmpDOB());
            dto.setEmpDOJ(entity.getEmpDOJ());
            dto.setEmpLocation(entity.getEmpLocation());
            dto.setEmpRole(entity.getEmpRole());
            dto.setEmpEmail(entity.getEmpEmail());
            dto.setEmpSkills(entity.getEmpSkills());
            dto.setManager(entity.getManager());
            // ... map other fields
            dtos.add(dto);
        }
        return dtos;
    }
    
   
    
    @Override
    public List<RegisterDto> getAllManagers() {
        List<RegisterEntity> managerEntities = registerRepository.findAllByEmpRole("manager");
        System.out.println(managerEntities);

        if ( !managerEntities.isEmpty()) {
            List<RegisterDto> managerDtos = convertToRegisterDtoList(managerEntities);
            return managerDtos;
        } else {
          throw new DataNotFoundException("No managers found");
        }
    }
    
    // testing code
    @Override
    public ResponseDto<ProjectDto> addProject(ProjectDto projectDto) {
        // Perform validation and data transformation here if needed
        // For example, check if managerEmployeeId exists in your employee records
      Optional<RegisterEntity> managerEntity = registerRepository.findByEmpId(projectDto.getManagerEmployeeId());
      System.out.println(managerEntity);
      
      if (managerEntity.isEmpty()) {
          // Handle the case where the managerEmployeeId does not exist
          return new ResponseDto<>("Manager not found", 404, null);
      }
      
      ProjectEntity existingProject = projectRepository.findByProjectId(projectDto.getProjectId());
      
      if (existingProject != null) {
          // A project with the same project ID already exists
          return new ResponseDto<>("Project ID already exists", 400, null);
      }

        // Create a ProjectEntity from the ProjectDto
        ProjectEntity projectEntity = new ProjectEntity(projectDto);

        // Save the project to the database
        projectRepository.save(projectEntity);

        // Return a success response
        return new ResponseDto<>("Project added successfully", 200, null);
    }
    
    @Override
    public ResponseDto<ProjectDto> getAllProjects() {
        List<ProjectEntity> projects = projectRepository.findAll();
        // Convert projects to a list of ProjectDto objects
        List<ProjectDto> projectDtos = convertToProjectDtoList(projects);
        return new ResponseDto<>("Projects retrieved successfully", 200, projectDtos);
    }
    
 // Implement a method to convert a list of ProjectEntity objects to ProjectDto objects
    private List<ProjectDto> convertToProjectDtoList(List<ProjectEntity> entities) {
        List<ProjectDto> dtos = new ArrayList<>();
        for (ProjectEntity entity : entities) {
            ProjectDto dto = new ProjectDto();
            // Map entity fields to dto fields
            dto.setName(entity.getName());
            dto.setDescription(entity.getDescription());
            dto.setStartDate(entity.getStartDate());
            dto.setManagerEmployeeId(entity.getManagerEmployeeId());
            dto.setSkills(entity.getSkills());
            // ... map other fields
            dtos.add(dto);
        }
        return dtos;
    }
    
    
    
  
    
}

